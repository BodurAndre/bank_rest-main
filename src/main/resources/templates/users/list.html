<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ - Bank Cards</title>
    <link rel="stylesheet" th:href="@{/css/cards.css}">
</head>
<body>
    <div class="header">
        <h1>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h1>
        <div class="header-actions">
            <a href="/users/create" class="btn btn-primary">‚ûï –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</a>
            <a href="/" class="btn btn-secondary">üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
            <a href="/logout" class="btn btn-secondary">–í—ã–π—Ç–∏</a>
        </div>
    </div>
    
    <div class="container">
        <!-- –°—Ç–∞—Ç—É—Å–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
        <div th:if="${successMessage}" class="status-notification" th:data-message="${successMessage}" data-type="success"></div>
        <div th:if="${errorMessage}" class="status-notification" th:data-message="${errorMessage}" data-type="error"></div>
        
        <!-- –§–∏–ª—å—Ç—Ä—ã -->
        <div class="filters">
            <form method="get" class="filter-form">
                <div class="filter-group">
                    <label for="search">–ü–æ–∏—Å–∫:</label>
                    <input type="text" id="search" name="search" th:value="${search}" 
                           placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏, email –∏–ª–∏ ID..." />
                </div>
                
                <div class="filter-group">
                    <label for="size">–ü–æ–∫–∞–∑–∞—Ç—å:</label>
                    <select id="size" name="size">
                        <option value="5" th:selected="${size == 5}">5</option>
                        <option value="10" th:selected="${size == 10}">10</option>
                        <option value="20" th:selected="${size == 20}">20</option>
                        <option value="50" th:selected="${size == 50}">50</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="sortBy">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</label>
                    <select id="sortBy" name="sortBy">
                        <option value="id" th:selected="${sortBy == 'id'}">ID</option>
                        <option value="firstName" th:selected="${sortBy == 'firstName'}">–ò–º—è</option>
                        <option value="lastName" th:selected="${sortBy == 'lastName'}">–§–∞–º–∏–ª–∏—è</option>
                        <option value="email" th:selected="${sortBy == 'email'}">Email</option>
                        <option value="role" th:selected="${sortBy == 'role'}">–†–æ–ª—å</option>
                        <option value="createdAt" th:selected="${sortBy == 'createdAt'}">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="sortDir">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</label>
                    <select id="sortDir" name="sortDir">
                        <option value="asc" th:selected="${sortDir == 'asc'}">–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</option>
                        <option value="desc" th:selected="${sortDir == 'desc'}">–ü–æ —É–±—ã–≤–∞–Ω–∏—é</option>
                    </select>
                </div>
                
                <button type="submit" class="btn btn-primary">üîç –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                <a href="/users" class="btn btn-secondary">üîÑ –°–±—Ä–æ—Å–∏—Ç—å</a>
            </form>
            
            <!-- –ö–Ω–æ–ø–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞ -->
            <div class="export-section">
                <button type="button" class="btn btn-export" onclick="showExportModal('users')">üìä –≠–∫—Å–ø–æ—Ä—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</button>
            </div>
        </div>
        
        <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
        <div class="users-grid">
            <div th:each="user : ${users}" class="user-card">
                <div class="user-header">
                    <div class="user-info">
                        <h3 th:text="${user.firstName + ' ' + user.lastName}">–ò–º—è –§–∞–º–∏–ª–∏—è</h3>
                        <p class="user-email" th:text="${user.email}">email@example.com</p>
                        <span class="user-role" th:class="'role-' + ${user.role.name().toLowerCase()}" 
                              th:text="${user.role.name()}">USER</span>
                    </div>
                    <div class="user-actions">
                        <a th:href="@{/users/{id}/edit(id=${user.id})}" class="btn btn-sm btn-primary">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                        <button type="button" class="btn btn-sm btn-danger delete-user-btn" 
                                th:data-user-id="${user.id}" 
                                th:data-user-name="${user.firstName + ' ' + user.lastName}">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </div>
                
                <div class="user-details">
                    <div class="detail-item">
                        <span class="label">ID:</span>
                        <span th:text="${user.id}">1</span>
                    </div>
                    <div class="detail-item" th:if="${user.country}">
                        <span class="label">–°—Ç—Ä–∞–Ω–∞:</span>
                        <span th:text="${user.country}">–†–æ—Å—Å–∏—è</span>
                    </div>
                    <div class="detail-item" th:if="${user.gender}">
                        <span class="label">–ü–æ–ª:</span>
                        <span th:text="${user.gender == 'Male' ? '–ú—É–∂—Å–∫–æ–π' : '–ñ–µ–Ω—Å–∫–∏–π'}">–ú—É–∂—Å–∫–æ–π</span>
                    </div>
                    <div class="detail-item" th:if="${user.dateOfBirth}">
                        <span class="label">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</span>
                        <span th:text="${user.dateOfBirth}">01.01.1990</span>
                    </div>
                    <div class="detail-item">
                        <span class="label">–°–æ–∑–¥–∞–Ω:</span>
                        <span th:text="${user.getCreatedAt()}">01.01.2024 12:00</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
        <div th:if="${totalPages > 1}" class="pagination">
            <div class="pagination-info">
                <span>–°—Ç—Ä–∞–Ω–∏—Ü–∞ <span th:text="${currentPage + 1}">1</span> –∏–∑ <span th:text="${totalPages}">1</span></span>
                <span>–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: <span th:text="${totalElements}">0</span></span>
            </div>
            
            <div class="pagination-controls">
                <a th:if="${currentPage > 0}" 
                   th:href="@{/users(page=${currentPage - 1}, size=${size}, sortBy=${sortBy}, sortDir=${sortDir}, search=${search})}" 
                   class="btn btn-sm">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è</a>
                
                <span th:each="pageNum : ${#numbers.sequence(0, totalPages - 1)}" 
                      th:if="${pageNum >= currentPage - 2 and pageNum <= currentPage + 2}">
                    <a th:if="${pageNum != currentPage}"
                       th:href="@{/users(page=${pageNum}, size=${size}, sortBy=${sortBy}, sortDir=${sortDir}, search=${search})}" 
                       class="btn btn-sm" th:text="${pageNum + 1}">1</a>
                    <span th:if="${pageNum == currentPage}" class="btn btn-sm btn-primary" th:text="${pageNum + 1}">1</span>
                </span>
                
                <a th:if="${currentPage < totalPages - 1}" 
                   th:href="@{/users(page=${currentPage + 1}, size=${size}, sortBy=${sortBy}, sortDir=${sortDir}, search=${search})}" 
                   class="btn btn-sm">–°–ª–µ–¥—É—é—â–∞—è ‚Üí</a>
            </div>
        </div>
    </div>

    <script th:src="@{/js/cards.js}"></script>
    
    <script>
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–∞—Ç—É—Å–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        document.addEventListener('DOMContentLoaded', function() {
            const successNotification = document.querySelector('.status-notification[data-type="success"]');
            const errorNotification = document.querySelector('.status-notification[data-type="error"]');
            
            if (successNotification) {
                const message = successNotification.getAttribute('data-message');
                showStatusNotification(message, 'success');
            }
            
            if (errorNotification) {
                const message = errorNotification.getAttribute('data-message');
                showStatusNotification(message, 'error');
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è
            initializeDeleteButtons();
        });

        function initializeDeleteButtons() {
            const deleteButtons = document.querySelectorAll('.delete-user-btn');
            
            deleteButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const userId = this.getAttribute('data-user-id');
                    const userName = this.getAttribute('data-user-name');
                    deleteUser(userId, userName);
                });
            });
        }

        function deleteUser(userId, userName) {
            showCustomConfirm(
                'üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
                '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "' + userName + '"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!',
                '–£–¥–∞–ª–∏—Ç—å',
                '–û—Ç–º–µ–Ω–∞',
                () => {
                    fetch(`/users/${userId}/delete`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        }
                    })
                    .then(response => {
                        if (response.ok) {
                            return response.text();
                        } else {
                            throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                        }
                    })
                    .then(message => {
                        showCustomNotification('‚úÖ –£—Å–ø–µ—Ö', message, 'success');
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    })
                    .catch(error => {
                        showCustomNotification('‚ùå –û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + error.message, 'error');
                    });
                }
            );
        }
    </script>
    
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º JavaScript –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ -->
    <script th:src="@{/js/admin-export.js}"></script>
</body>
</html>
